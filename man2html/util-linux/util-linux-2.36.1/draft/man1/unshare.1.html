<HTML>
  <HEAD>
  <META CHARSET="UTF-8"/>
  <META HTTP-QUIV="Content-Type" CONTENT="text/html; charset=UTF-8"/>
  <LINK REL="stylesheet" TYPE="text/css"
	    HREF="../../../../css/jm-draft.css"/>
  <TITLE>Manpage of UNSHARE</TITLE>
</HEAD><BODY>
<H1>UNSHARE</H1>
Section: User Commands (1)<BR>Updated: February 2016<BR><A HREF="#index">Index</A>
<A HREF="https://github.com/ysatoautonomous/jm-draft/wiki">Return to Main Contents</A><HR>


<A NAME="lbAB">&nbsp;</A>
<H2>名前</H2>


unshare - プログラムを新しい名前空間で実行する。

<A NAME="lbAC">&nbsp;</A>
<H2>書式</H2>

<B>unshare</B>

[options]
[<I>program</I>

[<I>arguments</I>]]


<A NAME="lbAD">&nbsp;</A>
<H2>説明</H2>








<B>unshare</B>

コマンドは (以下に説明するコマンドラインオプションで指定された) 新しい名前空間を作成し、
指定した <I>program</I> を実行する。
<I>program</I> が指定されない場合、``${SHELL}'' (デフォルトは: /bin/sh) が実行される。
<P>


デフォルトでは、新しい名前空間は、その名前空間にメンバーがある限り、
永続化される。



/proc/<I>pid</I>/ns/<I>type</I> ファイルを
ファイルシステムに bind マウントすることで、
メンバープロセスがない場合でも、新しい名前空間を永続化できる。





この方法で永続化された名前空間は、<I>program</I> が終了した後でも、その後で
<B><A HREF="../man1/nsenter.1.html">nsenter</A></B>(1)

で名前空間に入れることができる。
(PID 名前空間は例外であり、init プロセスをずっと動作させる必要がある)。




一度永続化した名前空間が必要なくなった場合、
<B><A HREF="../man8/umount.8.html">umount</A></B>(8)

で bind マウントを削除することで、永続化を解除できる。

より詳細は、「<B>例</B>」のセクションを参照すること。
<P>




util-linux バージョン 2.36 以降の
<B>unshare</B>

は、永続化 PID 名前空間と永続化時間 (TIME) 名前空間に、
/<I>proc/[pid]/ns/pid_for_children</I> と
proc/[pid]/ns/time_for_children ファイルを使う。
この変更は、Linux カーネル 4.17 以降が必要である。
<P>



以下のタイプの名前空間が、
<B>unshare</B>

で作成できる:
<DL COMPACT>
<DT><B>マウント名前空間</B>

<DD>





ファイルシステムのマウントとアンマウントが、他のファイルシステムに
影響しない。
ただし、明示的に共有 (shared) とマークされているファイルシステムは除く
(共有は <B>mount --make-shared</B> で行われる。
<I>/proc/self/mountinfo</I> または
<B>findmnt -o+PROPAGATION</B> で <B>shared</B> フラグを参照すること)。


より詳細は、
<B><A HREF="../man7/mount_namespaces.7.html">mount_namespaces</A></B>(7)

を参照すること。
<DT><DD>






<B>unshare</B>

は util-linux バージョン 2.27 以降で、新たなマウント名前空間で伝搬 (propagation) を
自動的に <B>private</B> にして、新しい名前空間を共有しないようにする。
この機能はオプション <B>--propagation unchanged</B> で無効化できる。
<B>private</B> はカーネルのデフォルトである点に注意すること。
<DT><B>UTS 名前空間</B>

<DD>


ホスト名またはドメイン名の設定が、システムの他の部分に影響しない。


より詳細は、
<B><A HREF="../man7/uts_namespaces.7.html">uts_namespaces</A></B>(7)

を参照すること。
<DT><B>IPC 名前空間</B>

<DD>




POSIX メッセージキューと、System V メッセージキュー、
セマフォセット、共有メモリセグメントについて、プロセスは独立した
名前空間を持つ。


より詳細は、
<B><A HREF="../man7/ipc_namespaces.7.html">ipc_namespaces</A></B>(7)

を参照すること。
<DT><B>ネットワーク名前空間</B>

<DD>




プロセスが独立した IPv4 と IPv6 スタック、IP ルーティングテーブル、
ファイアウォールルール、
<I>/proc:/net</I>

と
<I>/sys:/class:/net</I>

のディレクトリツリー、ソケットなどを持つ。


より詳細は、
<B><A HREF="../man7/network_namespaces.7.html">network_namespaces</A></B>(7)

を参照すること。
<DT><B>PID 名前空間</B>

<DD>


親プロセスとは別に、子プロセスがプロセスマッピングをするための PID セットを持つ。


より詳細は、
<B><A HREF="../man7/pid_namespaces.7.html">pid_namespaces</A></B>(7)

を参照すること。
<DT><B>コントロールグループ (cgroup) 名前空間</B>

<DD>



プロセスが <I>/proc:/self:/cgroup</I> の仮想化されたビューを持ち、
新しい cgroup マウントで名前空間の cgroup ルートがルートにされる。


より詳細は、
<B><A HREF="../man7/cgroup_namespaces.7.html">cgroup_namespaces</A></B>(7)

を参照すること。
<DT><B>ユーザー名前空間</B>

<DD>


プロセスが個別の UID、GID、ケーパビリティ (capabilities) のセットを持つ。


より詳細は、
<B><A HREF="../man7/user_namespaces.7.html">user_namespaces</A></B>(7)

を参照すること。
<DT><B>時間 (time) 名前空間</B>

<DD>






プロセスが
<B>CLOCK_MONOTONIC</B>

かつ/または
<B>CLOCK_BOOTTIME</B>

の異なるビューを持ち、<I>/proc/self/timens_offsets</I> で変更できる。


より詳細は、
<B><A HREF="../man7/time_namespaces.7.html">time_namespaces</A></B>(7)

を参照すること。

</DL>
<A NAME="lbAE">&nbsp;</A>
<H2>オプション</H2>

<DL COMPACT>
<DT><B>-i</B>,<B> --ipc</B>[<B>=</B><I>file</I>]

<DD>


IPC 名前空間を共有しない。
<I>file</I> が指定された場合、永続化された名前空間が bind マウントにより作成される。
<DT><B>-m</B>,<B> --mount</B>[<B>=</B><I>file</I>]

<DD>






マウント名前空間を共有しない。
<I>file</I> が指定された場合、永続化された名前空間が bind マウントにより作成される。
<I>file</I> は伝搬フラグを <B>shared</B> 以外に設定したファイルシステムに
置かれる必要がある点に注意すること (さもないと、エラーになる)。
現在の設定が分からない場合は、コマンド <B>findmnt -o+PROPAGATION</B> を使うこと。
以下の例も参照すること。
<DT><B>-n</B>,<B> --net</B>[<B>=</B><I>file</I>]

<DD>


ネットワーク名前空間を共有しない。
<I>file</I> が指定された場合、永続化された名前空間が bind マウントにより作成される。
<DT><B>-p</B>,<B> --pid</B>[<B>=</B><I>file</I>]

<DD>


PID 名前空間を共有しない。
<I>file</I> が指定された場合、永続化された名前空間が bind マウントにより作成される。



(<B>--fork</B>

オプションも一緒に指定しないと、永続化 PID 名前空間の作成は失敗する。)
<DT><DD>


<B>--fork</B> と <B>--mount-proc</B> オプションも参照すること。
<DT><B>-u</B>,<B> --uts</B>[<B>=</B><I>file</I>]

<DD>


UTS 名前空間を共有しない。
<I>file</I> が指定された場合、永続化された名前空間が bind マウントにより作成される。
<DT><B>-U</B>,<B> --user</B>[<B>=</B><I>file</I>]

<DD>


ユーザー名前空間を共有しない。
<I>file</I> が指定された場合、永続化された名前空間が bind マウントにより作成される。
<DT><B>-C</B>,<B> --cgroup</B>[<B>=</B><I>file</I>]

<DD>


cgroup 名前空間を共有しない。
<I>file</I> が指定された場合、永続化された名前空間が bind マウントにより作成される。
<DT><B>-T</B>,<B> --time</B>[<B>=</B><I>file</I>]

<DD>




時間名前空間を共有しない。
<I>file</I> を指定すると、bind マウントにより永続化名前空間が作成される。
<B>--monotonic</B> と <B>--boottime</B> を使って、
時間名前空間での対応するオフセットを指定できる。
<DT><B>-f</B>,<B> --fork</B>

<DD>


指定された <I>program</I> を、直接実行するのではなく、
<B>unshare</B> の子プロセスとして fork する。
これは新しい PID 名前空間を作成する際に役立つ。



<B>unshare</B> が子プロセスを待っている時、SIGINT と SIGTERM を無視して、
子プロセスにシグナルを送らない点に注意すること。
これは、子プロセスにシグナルを送るために必要である。
<DT><B>--keep-caps</B>

<DD>


<B>--user</B> オプションが指定された場合、
名前空間に許可されたケーパビリティは、子プロセスにも保持される。
<DT><B>--kill-child</B>[<B>=</B><I>signame</I>]

<DD>





<B>unshare</B> が終了する時に、fork した子プロセスに <I>signame</I> を送る。
<B>--pid</B> と組み合わせることにより、<B>unshare</B> 以下のプロセスツリー全体を、
簡単に確実に kill することができる。
<I>signame</I> が指定されない場合、デフォルトは <B>SIGKILL</B> である。
このオプションは <B>--fork</B> を暗黙のうちに指定する。
<DT><B>--mount-proc</B>[<B>=</B><I>mountpoint</I>]

<DD>





プログラムを実行する直前に、proc ファイルシステムを <I>mountpoint</I>
(デフォルトは /proc) にマウントする。
これは新しい PID 名前空間を作成するのに役立つ。
これは暗黙のうちに新しいマウント名前空間を作成する。
そうしなければ、/proc マウントはシステム上の既存のプログラムの実行に失敗する。
新しい proc システムは、(MS_PRIVATE|MS_REC で) 明示的に private としてマウントされる。
<DT><B>--map-user=</B><I>uid|name</I>

<DD>



現在の実効 (effective) ユーザー ID を <I>uid</I> にマッピングした後で、
プログラムを実行する。
このオプションは複数回指定可能で、最後の指定が優先される。
このオプションは <B>--user</B> を暗黙のうちに指定する。
<DT><B>--map-group=</B><I>gid|name</I>

<DD>



現在の実効 (effective) グループ ID を <I>gid</I> にマッピングした後で、
プログラムを実行する。
このオプションは複数回指定可能で、最後の指定が優先される。
このオプションは <B>--setgroups=deny</B> と
<B>--user</B> を暗黙のうちに指定する。
<DT><B>-r</B>,<B> --map-root-user</B>

<DD>







現在の実効 (effective) ユーザー ID と実効グループ ID を、
新しく作られた名前空間のスーパーユーザーの UID と GID にマッピングした後で、
プログラムを実行する。
これにより、非特権で実行されている場合でも、
新しく作られた名前空間のいろいろな側面を管理するのに必要な
ケーパビリティ (capabilities) を簡単に取得できる
(これには、ネットワーク名前空間でのインタフェースの設定や、
マウント名前空間でのファイルシステムのマウントなどがある)。
これは単なる便利機能に過ぎず、複数の範囲の UID と GID をマッピングするといった、
より洗練された使い方はサポートしていない。
このオプションは、<B>--setgroups=deny</B> と
<B>--user</B> を暗黙のうちに指定する。

このオプションは、<B>--map-user=0 --map-group=0</B> と同じである。
<DT><B>-c</B>,<B> --map-current-user</B>

<DD>




現在の実効ユーザー ID と実効グループ ID を、新しく作られた名前空間で
同じ UID と GID にマッピングした後で、プログラムを実行する。
このオプションは、<B>--setgroups=deny</B> と
<B>--user</B> を暗黙のうちに指定する。
このオプションは <B>--map-user=$(id -ru) --map-group=$(id -rg)</B> と同じである。
<DT><B>--propagation private</B>|<B>shared</B>|<B>slave</B>|<B>unchanged</B>

<DD>




新しいマウント名前空間のマウント伝搬フラグを再帰的に設定する。
デフォルトでは伝搬を <I>private</I>　に設定する。
この機能は引き数 <B>unchanged</B> で無効化できる。
このオプションは、マウント名前空間 (<B>--mount</B>) が指定されない場合、
黙って無視される。
<DT><B>--setgroups allow</B>|<B>deny</B>

<DD>



ユーザー名前空間で
<B><A HREF="../man2/setgroups.2.html">setgroups</A></B>(2)

システムコールを許可または拒否する。
<P>



<B><A HREF="../man2/setgroups.2.html">setgroups</A></B>(2)

を呼び出すには、呼び出しプロセスは少なくとも CAP_SETGID 権限を持たなければならない。




しかし、Linux 3.19 以降ではさらに厳しい制限が適用される:
GID マップ (<B>/proc/</B><I>pid</I><B>/gid_map</B>) が設定された後でのみ、
カーネルは、
<B><A HREF="../man2/setgroups.2.html">setgroups</A></B>(2)

の呼び出しを許可する。






(<B>allow</B>, デフォルトで)
<B><A HREF="../man2/setgroups.2.html">setgroups</A></B>(2)

が有効化されると、GID マップは root による書き込みが可能なる。
(<B>deny</B> で)
<B><A HREF="../man2/setgroups.2.html">setgroups</A></B>(2)

が永続的に無効化されると、GID マップは非特権プロセスによる書き込みが可能になる。
<DT><B>-R</B>,<B> --root=</B><I>dir</I>

<DD>

ルートディレクトリを <I>dir</I> に設定し、コマンドを実行する。
<DT><B>-w</B>,<B> --wd=</B><I>dir</I>

<DD>

ワーキングディレクトリを <I>dir</I> に変更する。
<DT><B>-S</B>,<B> --setuid </B><I>uid</I>

<DD>

名前空間全体で使われるユーザー ID を設定する。
<DT><B>-G</B>,<B> --setgid </B><I>gid</I>

<DD>


名前空間全体で使われるグループ ID を設定し、補助 (supplementary) グループを削除する。
<DT><B>--monotonic</B><I> offset</I>

<DD>




時間名前空間に入った際に使われる
<B>CLOCK_MONOTONIC</B>

のオフセットを指定する。
このオプションは、
<B>--time</B> で時間名前空間を共有しないことが必要である。
<DT><B>--boottime</B><I> offset</I>

<DD>




時間名前空間に入った際に使われる
<B>CLOCK_BOOTTIME</B>

のオフセットを指定する。
このオプションは、
<B>--time</B> で時間名前空間を共有しないことが必要である。
<DT><B>-V</B>,<B> --version</B>

<DD>

バージョン情報を表示して、終了する。
<DT><B>-h</B>,<B> --help</B>

<DD>

ヘルプを表示して、終了する。

</DL>
<A NAME="lbAF">&nbsp;</A>
<H2>注意</H2>





ユーザー名前空間で root として proc と sysfs ファイルシステムをマウントすることは
制限されなければならない。
これにより、特権のあるユーザーが見えなくした機微なファイルを、
特権の少ないユーザーがアクセスできないようにできる。
端的にいうと、proc と sysfs は可能な限り閉じて bind マウントしなければならない。

<A NAME="lbAG">&nbsp;</A>
<H2>例</H2>





以下のコマンドは
<B>--fork</B>

で PID 名前空間を作成し、実行されたコマンドが PID 1 の
子プロセス (名前空間の最初のプロセス) で実行されることを保証する。







<B>--mount-proc</B>

オプションを指定すると、新しいマウント名前空間も同時に作成され、
新しい
<B><A HREF="../man5/proc.5.html">proc</A></B>(5)

ファイルシステムがマウントされ、新しい PID 名前空間に対応する情報が格納される。



<B>readlink</B>

コマンドが終了すると、新しい名前空間は自動的に解放される。
<P>



<B># unshare --fork --pid --mount-proc readlink /proc/self</B>

1


<P>



非特権ユーザーで、新しいユーザー名前空間を作成し、
ユーザーのクレデンシャル (credentials) を
名前空間内の root ID にマップする。
<P>



<B>$ id -u; id -g</B>

1000
1000
<B>$ unshare --user --map-root-user \</B>

<B>        sh -c 'whoami; cat /proc/self/uid_map /proc/self/gid_map'</B>

root
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1


<P>



以下の最初のコマンドは、新しい永続化 UTS 名前空間を作成し、
名前空間で見えるホスト名を変更している。



次に、
<B><A HREF="../man1/nsenter.1.html">nsenter</A></B>(1)

で名前空間に入って、変更したホスト名を表示している。




このステップでは、
<B>unshare</B>

コマンドが終了した後で、名前空間にメンバープロセスがない状態にも
関わらず、
UTS 名前空間が継続していることを示している。

その後、名前空間は bind マウントを削除することで破壊される。
<P>



<B># touch /root/uts-ns</B>

<B># unshare --uts=/root/uts-ns hostname FOO</B>

<B># nsenter --uts=/root/uts-ns hostname</B>

FOO
<B># umount /root/uts-ns</B>



<P>




以下のコマンドは、bind マウント
<I>/root/namespaces/mnt</I>

で参照される、永続化マウント名前空間を作成する。





bind マウントの作成を成功させるため、
親ディレクトリ
(<I>/root/namespaces</I>)

は伝搬 (propagation) タイプを
<B>shared</B>

以外にして、bind マウントを作成されている。
<P>



<B># mount --bind /root/namespaces /root/namespaces</B>

<B># mount --make-private /root/namespaces</B>

<B># touch /root/namespaces/mnt</B>

<B># unshare --mount=/root/namespaces/mnt</B>



<P>






以下のコマンドは、PID 名前空間を作成する際の、
<B>--kill-child</B>

オプションの使い方を示している。
<B>unshare</B>

が kill された場合、PID 名前空間内のすべてのプロセスが kill されることを確かめている。
<P>




<B># set +m                </B># ジョブのステータスメッセージを表示しない

<B># unshare --pid --fork --mount-proc --kill-child -- \</B>

<B>       bash --norc -c '(sleep 555 &amp;) &amp;&amp; (ps a &amp;) &amp;&amp; sleep 999' &amp;</B>

[1] 53456
#     PID TTY      STAT   TIME COMMAND
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;pts/3&nbsp;&nbsp;&nbsp;&nbsp;S+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;sleep&nbsp;999
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;pts/3&nbsp;&nbsp;&nbsp;&nbsp;S+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;sleep&nbsp;555
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;pts/3&nbsp;&nbsp;&nbsp;&nbsp;R+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;ps&nbsp;a
<P>

<B># ps h -o 'comm' $!     </B># バックグラウンドジョブが <A HREF="../man1/unshare.1.html">unshare</A>(1) であることを表示する

unshare

<B># kill $!               </B># <A HREF="../man1/unshare.1.html">unshare</A>(1) を kill する

<B># pidof sleep</B>



<P>






<B>sleep</B>

は kill されているので、
<B>pidof</B>

コマンドは何も出力しない。




より正確には、名前空間で PID 1 の
<B>sleep</B>

プロセス (つまり、名前空間の init プロセス) が kill されるとき、
名前空間の他のすべてのプロセスが kill される。





反対に、
<B>--kill-child</B>

オプションが使われない場合、同様のコマンドで
<B>unshare</B>

が終了した場合に、PID 名前空間のプロセスは kill されない:
<P>



<B># unshare --pid --fork --mount-proc -- \</B>

<B>       bash --norc -c '(sleep 555 &amp;) &amp;&amp; (ps a &amp;) &amp;&amp; sleep 999' &amp;</B>

[1] 53479
#     PID TTY      STAT   TIME COMMAND
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;pts/3&nbsp;&nbsp;&nbsp;&nbsp;S+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;sleep&nbsp;999
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;pts/3&nbsp;&nbsp;&nbsp;&nbsp;S+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;sleep&nbsp;555
<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;pts/3&nbsp;&nbsp;&nbsp;&nbsp;R+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0:00&nbsp;ps&nbsp;a
<P>
<B># kill $!</B>

<B># pidof sleep</B>

53482 53480


<P>



以下の例では、時間名前空間を作成し、ブート時刻のクロックを数年前の
過去に設定している。
<P>




<B># uptime -p             </B># 最初の時間名前空間の uptime を表示する

up 21 hours, 30 minutes
<B># unshare --time --fork --boottime 300000000 uptime -p</B>

up 9 years, 28 weeks, 1 day, 2 hours, 50 minutes



<A NAME="lbAH">&nbsp;</A>
<H2>著者</H2>


Mikhail Gusarov

<BR>


Karel Zak


<A NAME="lbAI">&nbsp;</A>
<H2>関連項目</H2>

<B><A HREF="../man2/clone.2.html">clone</A></B>(2),

<B><A HREF="../man2/unshare.2.html">unshare</A></B>(2),

<B><A HREF="../man7/namespaces.7.html">namespaces</A></B>(7),

<B><A HREF="../man8/mount.8.html">mount</A></B>(8)


<A NAME="lbAJ">&nbsp;</A>
<H2>入手方法</H2>



unshare コマンドは util-linux パッケージの一部であり、
<A HREF="https://www.kernel.org/pub/linux/utils/util-linux/">https://www.kernel.org/pub/linux/utils/util-linux/</A>
から入手できる。
<P>

<HR>
<A NAME="index">&nbsp;</A><H2>Index</H2>
<DL>
<DT><A HREF="#lbAB">名前</A><DD>
<DT><A HREF="#lbAC">書式</A><DD>
<DT><A HREF="#lbAD">説明</A><DD>
<DT><A HREF="#lbAE">オプション</A><DD>
<DT><A HREF="#lbAF">注意</A><DD>
<DT><A HREF="#lbAG">例</A><DD>
<DT><A HREF="#lbAH">著者</A><DD>
<DT><A HREF="#lbAI">関連項目</A><DD>
<DT><A HREF="#lbAJ">入手方法</A><DD>
</DL>
<HR>
This document was created by
<A HREF="/man/man2html">man2html</A>,
using the manual pages.<BR>
Time: 15:30:54 GMT, January 23, 2021
</BODY>
</HTML>
